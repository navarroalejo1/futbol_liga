# calendario
import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime
from pathlib import Path
import os

# Configuraci√≥n de la base de datos
DB_PATH = Path(__file__).resolve().parent.parent.parent / "data" / "futbol.db"
os.makedirs(DB_PATH.parent, exist_ok=True)

def init_db():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS partidos (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        fecha DATE NOT NULL,
        hora TIME,
        local TEXT NOT NULL,
        visitante TEXT NOT NULL,
        competicion TEXT,
        lugar TEXT,
        UNIQUE(fecha, local, visitante)
    ''')
    conn.commit()
    return conn

def guardar_partido(fecha, hora, local, visitante, competicion, lugar):
    conn = init_db()
    try:
        conn.execute(
            """INSERT INTO partidos (fecha, hora, local, visitante, competicion, lugar)
            VALUES (?, ?, ?, ?, ?, ?)""",
            (fecha, hora, local, visitante, competicion, lugar)
        )
        conn.commit()
        st.success("‚úÖ Partido a√±adido al calendario!")
    except sqlite3.IntegrityError:
        st.error("‚ùå Error: Este partido ya est√° registrado")

def cargar_calendario():
    conn = init_db()
    return pd.read_sql_query(
        "SELECT fecha, hora, local, visitante, competicion, lugar FROM partidos ORDER BY fecha, hora",
        conn
    )

def main():
    st.title("üìÖ Calendario de Partidos")
    st.markdown("---")
    
    with st.expander("‚ûï A√±adir Nuevo Partido", expanded=True):
        with st.form("form_partido"):
            col1, col2 = st.columns(2)
            
            with col1:
                fecha = st.date_input("Fecha", datetime.today())
                hora = st.time_input("Hora", datetime.now().time())
                local = st.text_input("Equipo Local", "Equipo A")
            
            with col2:
                visitante = st.text_input("Equipo Visitante", "Equipo B")
                competicion = st.text_input("Competici√≥n", "Liga Nacional")
                lugar = st.text_input("Lugar del Partido", "Estadio Principal")
            
            if st.form_submit_button("üíæ Guardar Partido"):
                guardar_partido(fecha, hora, local, visitante, competicion, lugar)
    
    st.subheader("Pr√≥ximos Partidos")
    calendario = cargar_calendario()
    if not calendario.empty:
        st.dataframe(
            calendario,
            column_config={
                "fecha": st.column_config.DateColumn("Fecha", format="DD/MM/YYYY"),
                "hora": st.column_config.TimeColumn("Hora", format="HH:mm"),
                "local": "Local",
                "visitante": "Visitante",
                "competicion": "Competici√≥n",
                "lugar": "Lugar"
            },
            hide_index=True
        )
    else:
        st.info("No hay partidos programados")

if __name__ == "__main__":
    main()
